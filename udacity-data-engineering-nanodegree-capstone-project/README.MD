# Data Engineering Capstone Project

## Bondora Secondary Market Transactions Data Warehouse on AWS

### Project Summary
Peer-to-peer lending is the practice of lending money to individuals or businesses through online services that match lenders with borrowers. It is presumed that, compared to stock markets, peer-to-peer lending tends to have less volatility [[1]](https://en.wikipedia.org/wiki/Peer-to-peer_lending).

The aim of the project is to check this presumption by combining secondary market transactions on [Bondora](https://www.bondora.com/en) marketplace together with stock markets information as well as macroeconomic indicators in an analytic database on AWS.

Bondora as a leading Estonian marketplace for peer-to-peer consumer lending has a well-established secondary markt and provides historical data on all secondary market transactions in a transparent way. The OMX Tallinn and EURO STOXX 50 indices (daily close price) are used as a reference to compare the Bondora secondary market activity with the volatility of stock markets on short-term basis. The medium-term activity of the second market is also compared with the following macroeconomic indicators of Estonia:
* quarterly house price index - an index that measures the changes in the transaction prices of dwellings purchased by households
* monthly harmonized unemployment rate - the number of unemployed persons as a percentage of the labour force based on International Labour Office (ILO) definition presented in seasonally adjusted form
* consumers - this indicator based on harmonised surveys about financial situation, general economic situation, price trends, unemployment, major purchases and savings

### Used Technologies
* Python
* AWS S3 bucket as a storage service for datasets
* AWS Redshift as a host of an analytics database


### Data Sources
The project uses the following data sources:
* [Bondora secondary market transaction history](https://www.bondora.com/marketing/media/ResaleArchive.zip) (more than 24.5 million records, 677 MB, zipped CSV)
  * The table includes all investments that have been put on the secondary market.
* [Bondora loan dataset](https://www.bondora.com/marketing/media/LoanData.zip) (153 tausend records, 27 MB, zipped CSV)
  * The table provides daily dataset of all loan data that is not covered by the data protection laws.
* [Yahoo Finance API](https://finance.yahoo.com/quotes/API,Documentation/view/v1/) (pandas dataframe)
  * This source is used to get close price of EURO STOXX 50 index with pandas_datareader.
* [Nasdaq Baltic](https://nasdaqbaltic.com/statistics/en/charts) (excel file)
  * This source is used to get close price of OMX Tallinn index as a excel table.
* [eurostat REST API](https://ec.europa.eu/eurostat/web/json-and-unicode-web-services) (JSON)
  * This source is used to get macroeconomic indicators (house price index, harmonised unemployment
    rates, and consumers) for Estonia.  

### Data Quality
Data quality checks are incorporated into the ETL process before dataframes are uploaded to an S3 bucket. For each dataframe the script:
* shows the dataframe size
* shows the number of duplicated rows in the dataframe and removes such rows
* shows columns contained absent values together with the number of absent values

### Data Model
The data model of the project includes the dimension table:

#### transactions
The table includes transactions performed on the secondary market.
 
| Column | Type | Description |
| ------ | ---- | ----------- |
| `loan_id` | `VARCHAR(36) NOT NULL` | unique ID given to all loan applications |
| `principal_at_end` | `REAL` | outstanding principal at end date |
| `discount_rate` | `REAL` | discount/mark-up set by the seller |
| `start_date` | `TIMESTAMP NOT NULL` | time when the investment was added to secondary market |
| `end_date` | `TIMESTAMP NOT NULL` | time when the investment left the secondary market |
| `offer_time` | `REAL` | the time difference in seconds between the end date and the start date |

and the following fact tables:

#### loans
The table includes basic information about loans.

| Column | Type | Description |
| ------ | ---- | ----------- |
| `loan_id` | `VARCHAR(36) NOT NULL PRIMARY KEY` | unique ID given to all loan applications |
| `user_name` | `VARCHAR(50)` | user name generated by the system for the borrower |
| `amount` | `REAL` | amount the borrower received on the primary market |
| `interest` | `REAL` | interest rate accepted in the loan application |
| `loan_duration` | `SMALLINT` | current loan duration in months |
| `monthly_payment` | `REAL` | estimated amount the borrower has to pay every month |
| `use_of_loan` | `SMALLINT` | -1 unknown; 0 loan consolidation; 1 real estate; 2 home improvement; 3 business; 4 education; 5 travel; 6 vehicle; 7 other; 8 health; 101 working capital financing; 102 purchase of machinery equipment; 103 renovation of real estate; 104 accounts receivable financing; 105 acquisition of means of transport; 106 construction finance; 107 acquisition of stocks; 108 acquisition of real estate; 109 guaranteeing obligation; 110 other business |
| `verification_type` | `SMALLINT` | method used for loan application data verification: -1 unknown; 1 income unverified; 2 income unverified, cross-referenced by phone; 3 income verified; 4 income and expenses verified |
| `loan_date` | `TIMESTAMP` | date when the loan was issued |
| `default_date` | `TIMESTAMP` | date when loan went into defaulted state and collection process was started |
| `debt_occured_on` | `TIMESTAMP` | date when principal debt occurred |
| `last_payment_on` | `TIMESTAMP` |  date of the current last payment received from the borrower |


#### borrowers
The table includes basic information about borrowers.

| Column | Type | Description |
| ------ | ---- | ----------- |
| `user_name` | `VARCHAR(32)PRIMARY KEY` | user name generated by the system for the borrower |
| `loan_application_started_date` | `TIMESTAMP PRIMARY KEY` | date when loan application was submitted |
| `age` | `SMALLINT` | age of the borrower when signing the loan application |
| `gender` | `SMALLINT` | -1 unknown; 0 male; 1 female |
| `country` | `VARCHAR(2)` | residency of the borrower: EE Estonia; FI Finland; ES Spain; SK Slovakia |
| `education` | `SMALLINT` | -1 unknown; 1 primary education; 2 basic education; 3 vocational education; 4 secondary education; 5 higher education |
| `marital_status` | `SMALLINT` | -1 unknown; 1 married; 2 cohabitant; 3 single; 4 divorced; 5 widow |
| `nr_of_dependants` | `SMALLINT` | number of children or other dependants |
| `employment_status` | `SMALLINT` | -1 unknown; 1 unemployed; 2 partially employed; 3 fully employed; 4 self-employed; 5 entrepreneur; 6 retiree |
| `occupation_area` | `SMALLINT` | -1 unknown; 1 other; 2 mining; 3 processing; 4 energy; 5 utilities; 6 construction; 7 retail and wholesale; 8 transport and warehousing; 9 hospitality and catering; 10 info and telecom; 11 finance and insurance; 12 real-estate; 13 research; 14 administrative; 15 civil service & military; 16 education; 17 healthcare and social help; 18 art and entertainment; 19 agriculture, forestry and fishing |
| `home_ownership_type` | `SMALLINT` | -1 unknown; 0 homeless; 1 owner; 2 living with parents; 3 tenant, pre-furnished property; 4 tenant, unfurnished property; 5 council house; 6 joint tenant; 7 joint ownership; 8 mortgage; 9 owner with encumbrance; 10 other |
| `income_total` | `REAL` | borrower's total income |
| `liabilities_total` | `REAL` | total monthly liabilities |
| `debt_to_income` | `REAL` | ratio of borrower's monthly gross income that goes toward paying loans |
| `free_cash` | `REAL` | discretionary income after monthly liabilities |


#### market
The table includes the daily close price of stock indices of Estonia (OMX Tallinn) and Eurozone (EURO STOXX 50).

| Column | Type | Description |
| ------ | ---- | ----------- |
| `date_id` | `DATE NOT NULL PRIMARY KEY` | date |
| `omx` | `REAL` | close price of OMX Tallinn index |
| `d_omx` | `REAL` | percentual daily change of OMX Tallinn index |
| `estoxx` | `REAL` | close price of EURO STOXX 50 index |
| `d_estoxx` | `REAL` | percentual daily change of EURO STOXX 50 index |


#### statistics
The table includes monthly calculated macroeconomic indicators of Estonia.

| Column | Type | Description |
| ------ | ---- | ----------- |
| `date_id` | `DATE NOT NULL PRIMARY KEY` | date |
| `house_price_index` | `REAL` | house price index |
| `harmonized_unemployment_rate` | `REAL` | harmonized unemployment rate |
| `consumers` | `REAL` | consumers |


### Project Files
* `aws.cfg`: configuration file
* `etl.py`: file with function to perform ETL steps
* `infrastructure.py`: file with functions to create the required infrastructure on AWS
* `README.MD`: this file
* `redshift_queries.py`: file with all queries needed to setup the project
* `requirements.txt`: file listing the required packages

### Project Usage
1. modify `aws.cfg` according to your needs
2. run `infrastructure.py` to create S3 bucket, Redshift cluster, and analytic tables
3. run `etl.py`
   * to download and process required data,
   * to put the data into pandas dataframes,
   * to upload these dataframes to S3 bucket as GZIP and CSV files,
   * to create staging tables in database,
   * to copy these files into staging tables,
   * to upsert data from staging tables into analytic tables,
   * to drop staging tables
4. if required modify `infrastructure.py` (uncomment lines `delete_cluster()` and `delete_bucket()`) and run it to destroy Redshift cluster and delete S3 bucket


### Other Scenarios

##### The data was increased by 100x.
In this case, it would be worth considering moving towards the big data technologies like Spark. 

##### The data populates a dashboard that must be updated on a daily basis by 7am every day.
Airflow can be utilized to schedule the ETL pipeline.

##### The database needed to be accessed by 100+ people.
Redshift is well suitable for a such situation because the data is distributed across all nodes of the cluster. And the number of nodes, if required, can be easily increased.